"""
Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
"""

import sys
import re
import random

from PyQt6.QtWidgets import *
from PyQt6.QtCore import Qt, QRegularExpression
from PyQt6.QtGui import QRegularExpressionValidator

from registration_system import RegistrationSystem, UserService, User, Validator
from database import get_connection
from styles import apply_shadow, LIGHT_MODE_QSS, DARK_MODE_QSS
from student import StudentDashboard
from admin import AdminDashboard

# ============================================================================
# VALIDATORS
# ============================================================================

class InputValidator:
    @staticmethod
    def validate_login(academic_id, email, password):
        errors = []
        if not academic_id and not email:
            errors.append("Ø§Ù„Ù…Ø¹Ø±Ù Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø·Ù„ÙˆØ¨")
        if email:
            valid, msg = Validator.validate_email(email)
            if not valid: errors.append(msg)
        if not password:
            errors.append("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø·Ù„ÙˆØ¨Ø©")
        return len(errors) == 0, errors
    
    @staticmethod
    def validate_registration(name, email, mobile, password):
        errors = []
        valid, msg = Validator.validate_text(name, "Ø§Ù„Ø§Ø³Ù…", 3)
        if not valid: errors.append(msg)
        valid, msg = Validator.validate_email(email)
        if not valid: errors.append(msg)
        if not re.match(r'^05[0-9]{8}$', mobile):
            errors.append("Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 05 ÙˆÙŠØªÙƒÙˆÙ† Ù…Ù† 10 Ø£Ø±Ù‚Ø§Ù…")
        if len(password) < 8:
            errors.append("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 8 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„")
        return len(errors) == 0, errors

# ============================================================================
# LOGIN DIALOG
# ============================================================================

class LoginDialog(QDialog):
    def __init__(self, user_service):
        super().__init__()
        self.user_service = user_service
        self.current_user = None
        
        self.setWindowTitle("ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - Ù†Ø¸Ø§Ù… ODUS")
        self.setLayoutDirection(Qt.LayoutDirection.RightToLeft)
        self.setGeometry(0, 0, 800, 600)
        
        self.init_ui()
    
    def init_ui(self):
        layout = QVBoxLayout(self)
        
        # Ø§Ù„Ø«ÙŠÙ…
        theme_btn = QPushButton("ğŸŒ™")
        theme_btn.setProperty("class", "theme_button")
        theme_layout = QHBoxLayout()
        theme_layout.addWidget(theme_btn)
        theme_layout.addStretch()
        layout.addLayout(theme_layout)
        
        # Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
        login_card = self.create_login_card()
        layout.addWidget(login_card)
        layout.addStretch()
    
    def create_login_card(self):
        frame = QFrame()
        frame.setProperty("class", "card")
        frame.setFixedSize(450, 500)
        apply_shadow(frame)
        
        layout = QVBoxLayout(frame)
        layout.setContentsMargins(40, 40, 40, 40)
        
        title = QLabel("Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ")
        title.setObjectName("TitleLabel")
        title.setAlignment(Qt.AlignmentFlag.AlignCenter)
        layout.addWidget(title)
        layout.addSpacing(20)
        
        # Ù†Ù…ÙˆØ°Ø¬
        form = QFormLayout()
        self.id_input = QLineEdit()
        self.id_input.setPlaceholderText("Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ")
        self.email_input = QLineEdit()
        self.email_input.setPlaceholderText("Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ")
        self.pass_input = QLineEdit()
        self.pass_input.setPlaceholderText("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±")
        self.pass_input.setEchoMode(QLineEdit.EchoMode.Password)
        
        form.addRow(QLabel("Ø§Ù„Ù…Ø¹Ø±Ù:"), self.id_input)
        form.addRow(QLabel("Ø§Ù„Ø¨Ø±ÙŠØ¯:"), self.email_input)
        form.addRow(QLabel("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:"), self.pass_input)
        layout.addLayout(form)
        layout.addStretch()
        
        # Ø£Ø²Ø±Ø§Ø±
        forgot_btn = QPushButton("Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ")
        forgot_btn.setProperty("class", "secondary")
        login_btn = QPushButton("ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„")
        login_btn.clicked.connect(self.handle_login)
        register_btn = QPushButton("Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯")
        register_btn.setProperty("class", "secondary")
        register_btn.clicked.connect(self.show_register)
        
        layout.addWidget(forgot_btn)
        layout.addWidget(login_btn)
        layout.addWidget(register_btn)
        
        return frame
    
    def handle_login(self):
        academic_id = self.id_input.text().strip()
        email = self.email_input.text().strip()
        password = self.pass_input.text()
        
        is_valid, errors = InputValidator.validate_login(academic_id, email, password)
        if not is_valid:
            QMessageBox.warning(self, "Ø®Ø·Ø£", "\n".join(errors))
            return
        
        identifier = academic_id if academic_id else email
        user = self.user_service.authenticate(identifier, password)
        
        if user:
            self.current_user = user
            self.accept()
        else:
            QMessageBox.warning(self, "Ø®Ø·Ø£", "Ø§Ù„Ù…Ø¹Ø±Ù Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©")
    
    def show_register(self):
        dialog = RegisterDialog(self.user_service, self)
        dialog.exec()
    
    def toggle_theme(self):
        app = QApplication.instance()
        current = app.styleSheet()
        app.setStyleSheet(DARK_MODE_QSS if current == LIGHT_MODE_QSS else LIGHT_MODE_QSS)

# ============================================================================
# REGISTER DIALOG
# ============================================================================

class RegisterDialog(QDialog):
    def __init__(self, user_service, parent=None):
        super().__init__(parent)
        self.user_service = user_service
        self.setWindowTitle("Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯")
        self.setLayoutDirection(Qt.LayoutDirection.RightToLeft)
        self.init_ui()
    
    def init_ui(self):
        layout = QVBoxLayout(self)
        
        card = QFrame()
        card.setProperty("class", "card")
        card.setFixedSize(400, 500)
        apply_shadow(card)
        
        card_layout = QVBoxLayout(card)
        card_layout.setContentsMargins(30, 30, 30, 30)
        
        title = QLabel("Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯")
        title.setObjectName("TitleLabel")
        title.setAlignment(Qt.AlignmentFlag.AlignCenter)
        card_layout.addWidget(title)
        card_layout.addSpacing(20)
        
        # Ù†Ù…ÙˆØ°Ø¬
        form = QFormLayout()
        self.name_input = QLineEdit()
        self.email_input = QLineEdit()
        self.mobile_input = QLineEdit()
        self.password_input = QLineEdit()
        self.password_input.setEchoMode(QLineEdit.EchoMode.Password)
        
        # Ù…Ø¯Ù‚Ù‚ Ø§Ù„Ø¬ÙˆØ§Ù„
        mobile_validator = QRegularExpressionValidator(QRegularExpression("^05[0-9]{8}$"))
        self.mobile_input.setValidator(mobile_validator)
        self.mobile_input.setPlaceholderText("05XXXXXXXX")
        
        form.addRow(QLabel("Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:"), self.name_input)
        form.addRow(QLabel("Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:"), self.email_input)
        form.addRow(QLabel("Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:"), self.mobile_input)
        form.addRow(QLabel("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:"), self.password_input)
        
        # Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
        self.program_combo = QComboBox()
        self.program_combo.addItems(['Computer', 'Communications', 'Power', 'Biomedical'])
        form.addRow(QLabel("Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬:"), self.program_combo)
        
        card_layout.addLayout(form)
        card_layout.addStretch()
        
        # Ø²Ø± Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡
        register_btn = QPushButton("Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨")
        register_btn.clicked.connect(self.create_account)
        card_layout.addWidget(register_btn)
        
        layout.addWidget(card)
    
    def create_account(self):
        name = self.name_input.text().strip()
        email = self.email_input.text().strip()
        mobile = self.mobile_input.text().strip()
        password = self.password_input.text()
        program = self.program_combo.currentText()
        
        is_valid, errors = InputValidator.validate_registration(name, email, mobile, password)
        if not is_valid:
            QMessageBox.warning(self, "Ø®Ø·Ø£", "\n".join(errors))
            return
        
        # ØªÙˆÙ„ÙŠØ¯ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯
        student_id = self.generate_student_id()
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨
        user_data = {
            'user_id': student_id,
            'email': email,
            'password': password,
            'role': 'student',
            'display_name': name,
            'mobile': mobile
        }
        
        success, message = self.user_service.create_user(user_data)
        
        if success:
            QMessageBox.information(self, "Ù†Ø¬Ø§Ø­", 
                f"ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨!\nØ§Ù„Ù…Ø¹Ø±Ù: {student_id}\nÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: {password}"
            )
            self.accept()
        else:
            QMessageBox.warning(self, "Ø®Ø·Ø£", message)
    
    def generate_student_id(self):
        while True:
            prefix = random.choice(['16', '27'])
            candidate = f"{prefix}{random.randint(10000, 99999)}"
            conn = get_connection()
            cursor = conn.cursor()
            cursor.execute("SELECT 1 FROM users WHERE student_id = ?", (candidate,))
            exists = cursor.fetchone() is not None
            conn.close()
            if not exists:
                return candidate

# ============================================================================
# MAIN APPLICATION
# ============================================================================

class MainApp(QApplication):
    def __init__(self, argv):
        super().__init__(argv)
        self.setStyleSheet(LIGHT_MODE_QSS)
        self.registration_system = RegistrationSystem()
        self.user_service = UserService()
    
    def run(self):
        while True:
            login = LoginDialog(self.user_service)
            if login.exec() != QDialog.DialogCode.Accepted:
                break
            
            user = login.current_user
            
            if user.is_student():
                # Ù‡Ù†Ø§ ÙŠØ¬Ø¨ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨
                QMessageBox.information(None, "Ù…Ø±Ø­Ø¨Ø§Ù‹", f"Ù…Ø±Ø­Ø¨Ø§Ù‹ {user.display_name}")
                continue
            elif user.is_admin():
                dashboard = AdminDashboard(user, self.registration_system)
                dashboard.show()
                self.exec()
        
        sys.exit(0)

# ============================================================================
# ENTRY POINT
# ============================================================================

if __name__ == '__main__':
    app = MainApp(sys.argv)
    app.run()
